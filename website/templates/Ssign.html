<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller sign up page</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style2.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/fc6d546fde.js" crossorigin="anonymous"></script>
     <!--Leaflet-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
    <nav>
        <div class="navbar">
            <div class="logo">
                <img src="{{ url_for('static', filename='photos/logo.png') }}" alt="mmu logo">
            </div> 
        </div>
    </nav>  

<div class="flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

    <section class="staffb">
        <h1>
            Register your stall<br>
            <span class="highlight">with us!</span>
        </h1>
        <p>Sign up easily,showcase your menu and you can<br>
            reaching new customers.
        </p>
    </section>

    <div class="middle">
        <h1>Ready to boost your sales?</h1>
        
        <form class="form-box" method="POST" action="{{ url_for('auth.Ssignup') }}" enctype="multipart/form-data">
            <div class="text">
                <input type="text" name="stallname" placeholder="Stall name" required>
                <input type="text" name= "stallowner" placeholder="Stall Owner name" required>
                <input type="text" name="email" placeholder="Email" required>
                <input type="text" name="password1" placeholder="Password" required>
                <input type="text" name="password2" placeholder="Comfirm Password" required>
                
                <div class="operating-hours">
                    <input type="text" name="openhour" placeholder="Open Hours" required>
                    <input type="text" name="closehour" placeholder="Close Hours" required>
                </div>

                <textarea placeholder="Stall Description" required></textarea>
            </div>

            <div class="image-upload">

                <div class="image-box">
                    <p class="upload-title">Stall Image:</p>
                    <label class="upload-area">
                        <i class="fa-solid fa-image"></i>
                        <input type="file" id="prof_pic" accept="image/*">
                       
                    </label>
                     <p class="file-name" id="prof_pic_name">No file chosen</p>
                    
                </div>

                <div class="image-box">
                    <p class="upload-title">Background Image:</p>
                    <label class="upload-area">
                        <i class="fa-solid fa-image"></i>
                        <input type="file" id="bg_pic" accept="image/*"> 
                    </label>
                    <p class="file-name" id="bg_pic_name">No file chosen</p>
                </div>
            </div>

            <div class="map-section">
                <p class="map-title">📍 Pin Your Location Here:</p>
            </div>

            
            <div id="map"></div>
            <input type="hidden" id="latitude" name="latitude">
            <input type="hidden" id="longitude" name="longitude">

            <div class="form-actions">
                <button type="submit" class="submit-btn">SUBMIT</button>
            </div>
        </form>
    </div>

    <section class="staffb2">

    </section>

    <script>
       function replaceIconWithImage(input) {
            const file = input.files[0];
            const label = input.parentElement;// 找到 label

        // 先找现有的 img 和 icon
    let img = label.querySelector("img");
    let icon = label.querySelector("i");


    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const label = input.parentElement;  // 找到 label
            const icon = label.querySelector("i"); // 找到里面的 icon

            // 检查是否已经有 <img>
            let img = label.querySelector("img");
            if (!img) {
                img = document.createElement("img");
                img.style.width = "120px";     // 预览图大小
                img.style.height = "100px";
                img.style.objectFit = "cover";
                img.style.borderRadius = "12px";

                label.insertBefore(img, input); // 放在 input 前面
                if (icon) icon.remove(); // 移除原来的 icon
            }
            img.src = e.target.result; // 设置预览图
        };
        reader.readAsDataURL(file);
    } else {
        // 如果没文件，就恢复原来的 icon
        if (img) img.remove();
        if (!icon) {
            const newIcon = document.createElement("i");
            newIcon.className = "fa-solid fa-image";
            label.insertBefore(newIcon, input);
        }
    }
}
    

       
        // Stall Image
        document.getElementById("prof_pic").addEventListener("change", function(){
          const fileName = this.files.length > 0 ? this.files[0].name : "No file chosen";
          document.getElementById("prof_pic_name").textContent = fileName;
          replaceIconWithImage(this); // ✅ 调用函数显示预览图
        });

        // Background Image
        document.getElementById("bg_pic").addEventListener("change", function(){
          const fileName = this.files.length > 0 ? this.files[0].name : "No file chosen";
          document.getElementById("bg_pic_name").textContent = fileName;
          replaceIconWithImage(this); // ✅ 调用函数显示预览图
        });

    </script>
</body>
</html>

    <!--Map JavaScript-->
   <script>
        const map = L.map("map");
        map.setView([2.92836,101.64188],16);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 20, //Setting Max Zoom to 20(Enough)
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map)

        //https://youtu.be/NyjMmNCtKf4?si=SwNnJNahhkbyNH-h
        //marker
        let marker;
        
        navigator.geolocation.watchPosition(success, error);

        function success(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            if (!marker) {
                marker = L.marker([lat,lng],{
                draggable: true
                }).addTo(map);

                marker.on("dragend",position);
            }

            else {
                marker.setLatLng([lat,lng]);
                position();
            }
        }

        function error(err) {
            if (err.code === 1) {
                alert("Please allow geolocation access")
            } else {
                alert("Cannot get current location")
            }
        }

        function position() {
            const GetPosition = marker.getLatLng();
            document.getElementById("latitude").value = GetPosition.lat
            document.getElementById("longitude").value = GetPosition.lng
            console.log(GetPosition.lat,GetPosition.lng)
            }

    </script>