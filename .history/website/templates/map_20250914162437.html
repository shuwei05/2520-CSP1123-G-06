<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Page</title>

    <!--Link to LeaftLet-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://kit.fontawesome.com/fc6d546fde.js" crossorigin="anonymous"></script>
    
    <!--Map CSS-->
    <style>
        /*marker color*/
        .huechange {
            filter: hue-rotate(120deg);
        }

        body,html {
            margin: 0;
            padding: 0;
        }
        
        p {
            margin: 0;
            padding: 0;
        }

        .navbar{
            position: fixed;
            top:0 ;
            left: 0;
            height: 80px;
            width: 100%;
            background: rgb(164, 231, 250);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 999;
        }

        .logo{
            font-size: 24px;
            font-weight: bold;
        }

        .logo img{
            height: 65px;
            transform: translateX(-10px);
        }
        /*Map*/
        #map {
            position: fixed;
            width: 100%;
            height: 100%;
            margin-top: 80px;
        }
        /*Map Zoom In and Zoom*/
        .map-zoom {
            width: 60%;
            left: 40%;
        }
        /*Sidebar*/
        .seller-info-sidebar {
            position: fixed;
            top: 80px;
            width: 40%;
            height: 100%;
            background-color: white;
            z-index: 500;
            display: none;
        }

        .seller-info-sidebar.active {
            display: block;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        /*Stall Info*/
        .stall-photo {
            width: 100%;
            height: 30%;
            box-shadow: 0 2px 2px rgba(0,0,0,0.3);
        }
        
        .stall-photo img {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }
        /*Stall Name & Rating*/
        #link-to-stall {
            text-decoration: none;
        }

        #link-to-stall:active {
            color: black;
        }

        #link-to-stall:visited {
            color: black;
        }

        .stallname-and-rating {
            display: flex;
            padding: 20px;
            align-items: flex-end;
            font-size: 18px;
            box-shadow: 0 2px 2px rgba(0,0,0,0.1);
            background-color: rgb(246, 246, 246);
            font-size: 25px;
        }
        
        .stall-link {
            margin-right: 10px;
            font-weight: bold;
            color: #000000;
            font-size: 30px;
            
        }

        .rating {
            display: flex;
            align-items: flex-end;
            font-size: 16px;
            color: rgb(150, 150, 150);
            margin-left: 10px;
            margin-top: -3px;
            }

        #star {
            margin-left: 5px;
            color: orange;
        }

        /*Tab*/
        .about-and-reviews-tab {
            display: flex;
            position: relative;
            width: 100%;
            box-shadow: 0 2px 2px rgba(0,0,0,0.1);
        }

        .about-and-reviews-tab input {
            display: none;
        }

        .about-and-reviews-tab label {
            display: flex;
            flex: 1 1;
            padding: 10px;
            align-items: center;
            text-align: center;
            justify-content: center;
            cursor: pointer;
        }

        .sidebar-content {
            display: block;
            position: absolute;
            margin-top: 45px;
            margin-left: 10px;
            padding: 10px;
        }

        .sidebar-content > div { /* > child combinator*/
            display: none;
        }

        .about-and-reviews-tab input:checked + label{
            background-color: rgb(247, 247, 247);
            box-shadow: inset 0 2px 3px rgba(0,0,0,0.1);
        }

        .about-and-reviews-tab input:active + label{
            background-color: rgb(240, 240, 240);
            box-shadow: inset 0 2px 3px rgba(0,0,0,0.1);
        }

        #about:checked ~ .sidebar-content .stall-details {
            display: block;
        }

        #reviews:checked ~ .sidebar-content .reviews {
            display: block;
        }

        /*+ close; ~ far*/
        .stall-details {
            line-height: 30px;
        }


        /*Return Button*/
        .return-button {
            position: fixed;
            width: 30px;
            height: 60px;
            top: 50%;
            left: 40%;
            border-style: none;
            border-top-right-radius: 15px;
            border-bottom-right-radius: 15px;
            background-color: white;
            z-index: 100;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            cursor: pointer;
            display: none;
        }

        .return-button.active {
            display: block;
        }

        /*Comment*/
        .reviews-list {
            width: 36vw;
        }

        .comment {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            }

        .comment a {
            font-size: 40px;        /* ‚úÖ Ë∞ÉÂ§ßÂ∞∫ÂØ∏ */
            color: #000000;         /* ‚úÖ Á∫ØÈªë */
            text-decoration: none;
        }


        


        /* Reviews List */
        .reviews-list {
            width: 36vw;
            height: 300px;
            overflow-y: auto;   /* ‚úÖ ÊªöÂä®Êù° */
            padding: 10px;
        }

        /* Each Review */
        .review-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Avatar */
        .review-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 16px;
        }

        /* User + Text */
        .review-content {
            flex: 1;
        }

        .review-user {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 14px;
        }

        .review-text {
            font-size: 13px;
            color: #333;
            line-height: 1.4;
        }

        .review-rating {
        margin-top: 5px;
        }

        .star {
        font-size: 18px;
        color: #ccc; /* empty star color */
        }

        .star.filled {
        color: #FFD700; /* gold for filled stars */
        }

    .review-photo {
    margin-top: 10px;
    }

    .review-photo img {
    max-width: 200px;   /* adjust size */
    max-height: 150px;
    border-radius: 8px;
    object-fit: cover;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .nav-center {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    font-size: 25px;
    }

    .nav-right {
    margin-left: auto;
    font-size: 35px;
    margin-right: 30px;
    }

    .flash-messages {
                position: fixed;       /* ÊîπÊàêÂõ∫ÂÆöÔºåË∑üÈöèÈ°µÈù¢ */
                top: 80px;             /* ÂàöÂ•ΩÂú® nav Â∫ï‰∏ã */
                left: 50%;
                transform: translateX(-50%);
                width: 80%;
                max-width: 600px;
                z-index: 2000;  
                font-size: 30px;
            }


        .flash-messages .alert {
            margin-bottom: 10px;
            text-align: center;
            animation: fadeOut 3s forwards;
            color: #313030;
            
        }
        @keyframes fadeOut {
            0%   { opacity: 1; }
            70%  { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }

    </style>
</head>
<body>
    <nav>



        <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="navbar">




            <div class="logo">
                <img src="{{ url_for('static',filename='photos/logo.png') }}" alt="mmu logo">
            </div>

                <div class="nav-center">
                    <a href="/menu">Menu</a>
                </div>


                <div class="nav-right">
                    <a href="/profile"><i class="fa-regular fa-user"></i></a>
                </div>

            
        </div>
    </nav>

    <div id="map"></div> 
    
    <aside id="seller-sidebar" class="seller-info-sidebar">
        <div class="stall-photo">
            <img class="stall-photo" id="stall-bg-pic" src="">
        </div>

        <div class="stallname-and-rating">
            <span id="stall-prefix"></span>
            <a id="link-to-stall" href=""><span id="stallname"></span></a>


            <div class="rating">
                <p>4.0</p>
                <p id="star">&#9733;</p>
            </div>
        </div>

        <div class="about-and-reviews-tab">
            <input type="radio" id="about" name="tab" checked>
            <label for="about">About</label>
            <input type="radio" id="reviews" name="tab">
            <label for="reviews">Reviews</label>
    
            <div class="sidebar-content">
                <div class="stall-details">
                    <p class="stall-status" id="stall-status"></p>
                    <p class="stall-opening-time" id="openinghour"></p>   
                </div>

                                <!-- Reviews + Comment Button -->
                <div class="reviews">

                    <div class="comment">
                        <a id="review-link" href="#">
                            <i class="fa fa-plus-square-o" aria-hidden="true"></i>
                        </a>
                    </div>

                    <div class="reviews-list" id="reviews-list">
                        <!-- Example review -->
                            {% for review in reviews %}
                            <div class="review-item">
                                <div class="review-avatar">üë§</div>
                                <div class="review-content">
                                    <p class="review-user">{{review.user.user_name}}</p>
                                    <p class="review-text">{{review.review}}</p>
                                    <p class="rating"></p>

                                    <div class="review-rating">
                                            <div class="star-rating">
                                                {# filled stars #}
                                                {% for i in range(review.rating | int) %}
                                                    <span class="star filled">‚òÖ</span>
                                                {% endfor %}

                                                {# empty stars #}
                                                {% for i in range(5 - (review.rating | int)) %}
                                                    <span class="star">‚òÖ</span>
                                                {% endfor %}
                                            </div>

                                            {% if review.review_pic %}
                                                <div class="review-photo">
                                                    <img src="{{ url_for('static', filename='uploads/' ~ review.review_pic) }}" alt="Review photo">
                                                </div>
                                            {% endif %}
                                </div>
                            </div>
                                {% else %}
                                    <p>No reviews yet.</p>
                            {% endfor %}
                    </div>
                    

    </aside>
    <button id="return" class="return-button">&#10094;</button>

</body>

<script id="stall-data" type="application/json">
    {{ (stall_data | tojson | safe) }}
</script>

<script>
    //map and seller location
    const bounds = L.latLngBounds(
        L.latLng(2.92416147468388,101.63546562194826), //SW
        L.latLng(2.931511848931281,101.64844751358034), //NE
        )
    const map = L.map("map", {
        maxBounds:bounds,
        maxBoundsViscosity:0.5
    });
    map.setView([2.92836,101.64188],17);
   
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20, //Setting Max Zoom to 20(Enough)
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map)

    const stall_data = JSON.parse(
        document.getElementById("stall-data").textContent
    );

    const stallname = document.getElementById("stallname")
    const openinghour = document.getElementById("openinghour")
    const ZoomMap = document.getElementById("map")
    const SidebarAppear= document.getElementById("seller-sidebar")
    const ReturnButton = document.getElementById("return")
    const StallBg = document.getElementById("stall-bg-pic")
    const stallMenu = document.getElementById("link-to-stall")


    for (const stall_info of stall_data){
        const marker = L.marker([stall_info.latitude,stall_info.longitude]).addTo(map);
        
        //Zoom Map When Click
        marker.on("click",function() {
            EnterZoomMap(stall_info);
            map.once("click",exitZoomMap); 
        })
    }

    function EnterZoomMap(stall_info) {
            map.setView([stall_info.latitude,stall_info.longitude],19);
            ZoomMap.classList.add("map-zoom");
            SidebarAppear.classList.add("active");
            ReturnButton.classList.add("active");
            stallname.textContent = stall_info.stallname;
            stallMenu.href = `/stall-menu/${stall_info.id}`;


            stallname.textContent = stall_info.stallname;

            openinghour.textContent = `Opening Hours : ${stall_info.openhour} to ${stall_info.closehour} `;
            StallBg.src = stall_info.background_pic;
            updateStallStatus(stall_info.openhour, stall_info.closehour);

            document.getElementById("review-link").href = `/map/${stall_info.id}`;

            window.location.href = `/map/${stall_info.id}`;


            history.pushState({}, "", `/map/${stall_info.id}`);

        }
    function exitZoomMap() {
            ZoomMap.classList.remove("map-zoom");
            SidebarAppear.classList.remove("active");
            ReturnButton.classList.remove("active")
            map.setView([2.92790,101.64188],17);

            history.pushState({}, "", "/map");

        }

    //user location
    let userMarker;
    const initialPosition = [2.929026, 101.641983]; //DTC as initial
    navigator.geolocation.getCurrentPosition(success, error);

    function success(pos) {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const userPosition = L.latLng(lat,lng);

            if (!userMarker) {
                if(bounds.contains(userPosition)) {
                    
                    userMarker = L.marker([lat,lng]).addTo(map);
                    userMarker._icon.classList.add("huechange");
                    position();
                } else {
                    alert("You are not in area of MMU!");
                    userMarker = L.marker(initialPosition,{
                    draggable: true
                    }).addTo(map);
                    userMarker._icon.classList.add("huechange");
                    position();
                }
            }

            else {
                if(bounds.contains(userPosition)) {
                    userMarker.setLatLng([lat,lng]);
                position();
            }}
        }

        function error(err) {
            if (err.code === 1) {
                alert("Please allow geolocation access")
            } else {
                alert("Cannot get current location")
            }
            
            userMarker = L.marker(initialPosition,{
                    draggable: true
                    }).addTo(map);
            userMarker._icon.classList.add("huechange");
            position();
        }

        //later delete, confirm the lat lng got change or not only
        function position() {
            const GetPosition = userMarker.getLatLng();
            console.log(GetPosition.lat,GetPosition.lng)
            }



    ReturnButton.addEventListener("click", exitZoomMap);
    
    //stall_data.forEach(stall => {
    //    const marker = L.marker([stall.latitude, stall.longitude]).addTo(map);
    //    marker.on("click", () => EnterZoomMap(stall));
    //});

    const pathParts = window.location.pathname.split("/");
    if (pathParts.length === 3 && pathParts[1] === "map") {
        const selectedId = parseInt(pathParts[2]);
        const stall = stall_data.find(s => s.id === selectedId);
        if (stall) {
            EnterZoomMap(stall);
            map.once("click",exitZoomMap);
        }
    }


        function updateStallStatus(openHour, closeHour) {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes(); // ËΩ¨ÂàÜÈíüÊñπ‰æøÊØîËæÉ

            const [openH, openM] = openHour.split(":").map(Number);
            const [closeH, closeM] = closeHour.split(":").map(Number);

            const openTime = openH * 60 + openM;
            const closeTime = closeH * 60 + closeM;

            const statusElement = document.getElementById("stall-status");

        if (currentTime >= openTime && currentTime <= closeTime) {
            statusElement.textContent = "Open";
            statusElement.style.color = "green";
        } else {
            statusElement.textContent = "Closed";
            statusElement.style.color = "red";
        }
        }

    // ÂÅáËÆæ‰Ω† stall Ëê•‰∏öÊó∂Èó¥ÊòØ 12:00 - 18:00
    //updateStallStatus("12:00", "18:00");


</script>
</html>